<template>
  <div>
    <div class="row mt-3">
      <div class="col-md-12">
        <h2 class="center-text mb-4">Production</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <Spinner v-if="isLoading" />
          <div class="card-body m-sm-4">
            <h4 class="center-text mb-4">Meals</h4>
            <div class="report-date-picker">
              <delivery-date-picker
                v-model="delivery_dates.meal_orders"
                ref="mealOrdersDates"
              ></delivery-date-picker>
              <b-btn @click="clearMealOrders()" class="ml-1">Clear</b-btn>
            </div>
            <p class="mt-4 center-text">
              Shows how many of each meal to make based on your orders.
            </p>
            <div class="row">
              <div class="col-md-6">
                <button
                  @click="print('meal_orders', 'pdf')"
                  class="btn btn-primary btn-md center mt-2 pull-right"
                >
                  Print
                </button>
              </div>
              <div class="col-md-6">
                <b-dropdown
                  variant="warning"
                  class="center mt-2"
                  right
                  text="Export as"
                >
                  <b-dropdown-item @click="exportData('meal_orders', 'csv')"
                    >CSV</b-dropdown-item
                  >
                  <b-dropdown-item @click="exportData('meal_orders', 'xls')"
                    >XLS</b-dropdown-item
                  >
                  <b-dropdown-item @click="exportData('meal_orders', 'pdf')"
                    >PDF</b-dropdown-item
                  >
                </b-dropdown>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-body m-sm-4">
            <h4 class="center-text mb-4">Ingredients</h4>
            <div class="report-date-picker">
              <delivery-date-picker
                v-model="delivery_dates.ingredient_quantities"
                :rtl="true"
                ref="ingredientQuantitiesDates"
              ></delivery-date-picker>
              <b-btn @click="clearIngredientQuantities()" class="ml-1"
                >Clear</b-btn
              >
            </div>
            <p class="mt-4 center-text">
              Shows how much of each ingredient is needed based on your orders.
            </p>
            <div class="row">
              <div class="col-md-6">
                <button
                  @click="print('ingredient_quantities', 'pdf')"
                  class="btn btn-primary btn-md center mt-2 pull-right"
                >
                  Print
                </button>
              </div>
              <div class="col-md-6">
                <b-dropdown
                  variant="warning"
                  class="center mt-2"
                  right
                  text="Export as"
                >
                  <b-dropdown-item
                    @click="exportData('ingredient_quantities', 'csv')"
                    >CSV</b-dropdown-item
                  >
                  <b-dropdown-item
                    @click="exportData('ingredient_quantities', 'xls')"
                    >XLS</b-dropdown-item
                  >
                  <b-dropdown-item
                    @click="exportData('ingredient_quantities', 'pdf')"
                    >PDF</b-dropdown-item
                  >
                </b-dropdown>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h2 class="center-text mb-4">Bagging & Delivery</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body m-sm-4">
            <h4 class="center-text mb-4">Orders Summary</h4>
            <div class="report-date-picker">
              <p v-if="pickupLocations.length > 0">Pickup Location</p>
              <b-select
                v-if="pickupLocations.length > 0"
                v-model="selectedPickupLocation"
                :options="pickupLocationOptions"
                class="delivery-select ml-2"
              ></b-select>
            </div>
            <div class="report-date-picker mt-2">
              <delivery-date-picker
                v-model="delivery_dates.orders_by_customer"
                ref="ordersByCustomerDates"
              ></delivery-date-picker>
              <b-btn @click="clearOrdersByCustomer()" class="ml-1">Clear</b-btn>
            </div>
            <p class="mt-4 center-text">
              Shows how to bag up your meals for each customer.
            </p>

            <div class="row">
              <div class="col-md-6">
                <button
                  @click="print('orders_by_customer', 'pdf')"
                  class="btn btn-primary btn-md center mt-2 pull-right"
                >
                  Print
                </button>
              </div>
              <div class="col-md-6">
                <b-dropdown
                  variant="warning"
                  class="center mt-2"
                  right
                  text="Export as"
                >
                  <b-dropdown-item
                    @click="exportData('orders_by_customer', 'csv')"
                    >CSV</b-dropdown-item
                  >
                  <b-dropdown-item
                    @click="exportData('orders_by_customer', 'xls')"
                    >XLS</b-dropdown-item
                  >
                  <b-dropdown-item
                    @click="exportData('orders_by_customer', 'pdf')"
                    >PDF</b-dropdown-item
                  >
                </b-dropdown>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body m-sm-4">
            <h4 class="center-text mb-4">Packing Slips</h4>
            <div class="report-date-picker">
              <p v-if="pickupLocations.length > 0">Pickup Location</p>
              <b-select
                v-if="pickupLocations.length > 0"
                v-model="selectedPickupLocation"
                :options="pickupLocationOptions"
                class="delivery-select ml-2"
              ></b-select>
            </div>
            <div class="report-date-picker mt-2">
              <delivery-date-picker
                v-model="delivery_dates.packing_slips"
                :rtl="true"
                ref="packingSlipsDates"
              ></delivery-date-picker>
              <b-btn @click="clearPackingSlips()" class="ml-1">Clear</b-btn>
            </div>
            <p class="mt-4 center-text">
              Packing slips will print 15 orders per browser tab.
            </p>
            <div class="row">
              <div class="col-md-12">
                <button
                  @click="print('packing_slips', 'pdf')"
                  class="btn btn-primary btn-md center mt-2 center"
                >
                  Print
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Showing report only for Livoti's who doesn't use the report for routes. Will add back when routes are fixed-->
    <div class="row">
      <div
        class="col-md-6"
        v-if="store.id === 108 || store.id === 109 || store.id === 110"
      >
        <div class="card">
          <div class="card-body m-sm-4">
            <h4 class="center-text mb-4">Delivery Routes</h4>
            <div class="report-date-picker">
              <delivery-date-picker
                v-model="delivery_dates.delivery_routes"
                ref="deliveryRoutesDates"
              ></delivery-date-picker>
              <b-btn @click="clearDeliveryRoutes()" class="ml-1">Clear</b-btn>
            </div>
            <p class="mt-4 center-text">
              Shows you the quickest route to make your deliveries.
            </p>
            <div class="row">
              <div class="col-md-12">
                <button
                  @click="print('delivery_routes', 'pdf')"
                  class="btn btn-primary btn-md center mt-2 center"
                >
                  Print
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body m-sm-4">
            <h4 class="center-text mb-2">Labels</h4>
            <h6 class="center-text text-danger mb-4">(Beta)</h6>
            <div class="report-date-picker">
              <delivery-date-picker
                v-model="delivery_dates.labels"
                ref="deliveryRoutesDates"
              ></delivery-date-picker>
              <b-btn @click="clearLabels()" class="ml-1">Clear</b-btn>
            </div>
            <p class="mt-4 center-text">Labels for your meal containers.</p>
            <div class="row">
              <div class="col-md-6">
                <button
                  class="btn btn-warning btn-md center mt-2 pull-right"
                  @click="showSettings('labels')"
                >
                  Settings
                </button>
              </div>
              <div class="col-md-6">
                <button
                  @click="print('labels', 'pdf')"
                  class="btn btn-secondary btn-md mt-2"
                >
                  Preview
                </button>
                <button
                  @click="print('labels', 'b64')"
                  class="btn btn-primary btn-md mt-2"
                >
                  Print
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h2 class="center-text mb-4">Payments</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body m-sm-4">
            <h4 class="center-text mb-4">Payments</h4>
            <div class="report-date-picker">
              <delivery-date-picker
                v-model="delivery_dates.payments"
                ref="payments"
                :orderDate="true"
              ></delivery-date-picker>
              <b-btn @click="clearDeliveryRoutes()" class="ml-1">Clear</b-btn>
            </div>
            <p class="mt-4 center-text">
              Gives you breakdowns of all your payments as well as totals for
              the date range you pick.
            </p>
            <div class="row">
              <div class="col-md-6">
                <button
                  @click="print('payments', 'pdf')"
                  class="btn btn-primary btn-md center mt-2 pull-right"
                >
                  Print
                </button>
              </div>
              <div class="col-md-6">
                <b-dropdown
                  variant="warning"
                  class="center mt-2"
                  right
                  text="Export as"
                >
                  <b-dropdown-item @click="exportData('payments', 'csv')"
                    >CSV</b-dropdown-item
                  >
                  <b-dropdown-item @click="exportData('payments', 'xls')"
                    >XLS</b-dropdown-item
                  >
                  <b-dropdown-item @click="exportData('payments', 'pdf')"
                    >PDF</b-dropdown-item
                  >
                </b-dropdown>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <b-modal
      size="xl"
      title="Labels Settings"
      v-model="showSettingsModal.labels"
      v-if="showSettingsModal.labels"
      no-fade
      no-close-on-backdrop
      @ok="updateReportSettings"
    >
      <b-alert variant="warning" show>
        <h6 class="center-text text-danger">Beta</h6>
        <p>
          This feature is currently in beta. It has only been tested on Dymo
          printers using a common label size of 4" by 2.33" inches. Please
          adjust the dimensions & margins below to see if it prints correctly
          for you. You can also try adjusting Printer Preferences on your
          computer. Try not to check all the boxes below as not everything can
          fit on the label. Utilize the Preview Label button to check.
        </p>
      </b-alert>
      <b-alert variant="info" show>
        <h6 class="center-text">Setup Instructions</h6>
        <p>
          #1
          <a
            href="https://github.com/qzind/tray/releases/download/v2.1.1/qz-tray-2.1.1.exe"
            target="_blank"
            class="strong"
            >Download QZ tray</a
          >
        </p>
        <p>
          #2 Run the installer on your computer and make sure the QZ Tray
          application is running. Refresh GoPrep and the red light at the top
          should show as green.
        </p>
        <p>
          #3 Click the printer icon at the top of GoPrep and choose your label
          printer.
        </p>
        <p>
          #4 Adjust and save the settings below. The label size is required but
          the margins can and should be left blank unless adjustment is needed.
        </p>
        <p>
          #5 Click the "Preview" button to see if the labels are coming out
          correctly. Test on a single order first on the orders page.
        </p>
      </b-alert>
      <div class="row">
        <div class="col-md-4">
          <p class="strong">Show the Following on the Label</p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_nutrition"
              >Nutrition</b-form-checkbox
            >
          </p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_macros"
              >Macros</b-form-checkbox
            >
          </p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_logo"
              >Logo</b-form-checkbox
            >
          </p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_website"
              >Website</b-form-checkbox
            >
          </p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_social"
              >Social Media Handle</b-form-checkbox
            >
          </p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_customer"
              >Customer Name</b-form-checkbox
            >
          </p>
          <!-- <p>
          <b-form-checkbox v-model="reportSettings.lab_description"
            >Meal Description</b-form-checkbox
          >
        </p> -->
          <p>
            <b-form-checkbox v-model="reportSettings.lab_instructions"
              >Meal Instructions</b-form-checkbox
            >
          </p>
          <p v-if="store.modules.mealExpiration">
            <b-form-checkbox v-model="reportSettings.lab_expiration"
              >Meal Expiration</b-form-checkbox
            >
          </p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_ingredients"
              >Ingredients</b-form-checkbox
            >
          </p>
          <p>
            <b-form-checkbox v-model="reportSettings.lab_allergies"
              >Allergens</b-form-checkbox
            >
          </p>
        </div>
        <div class="col-md-4">
          <p class="strong">Label Dimensions</p>
          <b-form-group class="mt-3">
            <b-input-group size="md" append="width">
              <b-input v-model="reportSettings.lab_width" type="number" />
            </b-input-group>
            <b-input-group size="md" append="height">
              <b-input v-model="reportSettings.lab_height" type="number" />
            </b-input-group>
          </b-form-group>
        </div>
        <div class="col-md-4">
          <p class="strong">Label Margins</p>
          <b-form-group class="mt-3">
            <b-input-group size="md" append="top">
              <b-input
                v-model="reportSettings.lab_margin_top"
                class="d-inline-block"
                type="number"
              />
            </b-input-group>
            <b-input-group size="md" append="right">
              <b-input
                v-model="reportSettings.lab_margin_right"
                type="number"
              />
            </b-input-group>
            <b-input-group size="md" append="bottom">
              <b-input
                v-model="reportSettings.lab_margin_bottom"
                class="d-inline-block"
                type="number"
              />
            </b-input-group>
            <b-input-group size="md" append="left">
              <b-input
                v-model="reportSettings.lab_margin_left"
                class="d-inline-block"
                type="number"
              />
            </b-input-group>
          </b-form-group>
        </div>
      </div>

      <b-btn variant="primary" @click="updateReportSettings">Save</b-btn>
    </b-modal>
  </div>
</template>

<style lang="scss" scoped>
.report-date-picker {
  display: flex;
  justify-content: center;
}
</style>

<script>
import { mapGetters, mapActions, mapMutations } from "vuex";
import vSelect from "vue-select";
import Spinner from "../../components/Spinner";
import checkDateRange from "../../mixins/deliveryDates";
import printer from "../../mixins/printer";
import { sleep } from "../../lib/utils";
import { PrintJob, PrintSize } from "../../store/printer";

export default {
  components: {
    vSelect,
    Spinner
  },
  data() {
    return {
      delivery_dates: {
        meal_quantities: [],
        meal_orders: [],
        ingredient_quantities: [],
        orders_by_customer: [],
        packing_slips: [],
        delivery_routes: [],
        payments: [],
        labels: []
      },
      showSettingsModal: {
        labels: false
      },
      labelSize: {
        width: 4,
        height: 6
      },
      labelSizeOptions: [
        {
          text: "A4",
          value: {
            width: 8.3,
            height: 11.7
          }
        },
        {
          text: "Letter",
          value: {
            width: 8.5,
            height: 11
          }
        },
        {
          text: '4" x 6"',
          value: {
            width: 4,
            height: 6
          }
        },
        {
          text: '4" x 8"',
          value: {
            width: 4,
            height: 8
          }
        },
        {
          text: '6" x 4"',
          value: {
            width: 6,
            height: 4
          }
        },
        {
          text: '8" x 11"',
          value: {
            width: 8,
            height: 11
          }
        }
      ],
      selectedPickupLocation: null
    };
  },
  computed: {
    ...mapGetters({
      store: "viewedStore",
      orders: "storeOrders",
      isLoading: "isLoading",
      pickupLocations: "viewedStorePickupLocations",
      reportSettings: "storeReportSettings"
    }),
    pickupLocationOptions() {
      return this.pickupLocations.map(loc => {
        return {
          value: loc.id,
          text: loc.name,
          instructions: loc.instructions
        };
      });
    },
    selected() {
      return this.deliveryDates;
    },
    deliveryDates() {
      let grouped = [];
      this.orders.forEach(order => {
        if (!_.includes(grouped, order.delivery_date)) {
          grouped.push(order.delivery_date);
        }
      });
      this.deliveryDate = grouped[0];
      return grouped;
    }
  },
  mixins: [checkDateRange, printer],
  async mounted() {},
  methods: {
    ...mapActions(["printer/connect", "refreshStoreReportSettings"]),

    async print(report, format = "pdf", page = 1) {
      let params = { page };

      let dates = this.delivery_dates[report];

      if (dates.start && dates.end) {
        params.delivery_dates = {
          from: dates.start,
          to: dates.end
        };
        // const warning = this.checkDateRange({ ...dates });
        // if (report != "payments") {
        //   if (warning) {
        //     try {
        //       let dialog = await this.$dialog.confirm(
        //         "You have selected a date range which includes delivery days which haven't passe" +
        //           "d their cutoff period. This means new orders can still come in for those days. Continue?"
        //       );
        //       dialog.close();
        //     } catch (e) {
        //       return;
        //     }
        //   }
        // }
      }
      if (dates.start && !dates.end) {
        params.delivery_dates = {
          from: dates.start,
          to: dates.start
        };

        // const warning = this.checkDateRange({ ...dates });
        // if (report != "payments") {
        //   if (warning) {
        //     try {
        //       let dialog = await this.$dialog.confirm(
        //         "You have selected a date range which includes delivery days which haven't passe" +
        //           "d their cutoff period. This means new orders can still come in for those days. Continue?"
        //       );
        //       dialog.close();
        //     } catch (e) {
        //       return;
        //     }
        //   }
        // }
      }

      params.dailySummary = 0;

      params.pickupLocationId = this.selectedPickupLocation;

      params.byOrderDate = 0;

      params.labelsNutrition = this.labelsNutrition;

      params.width = this.reportSettings.lab_width;
      params.height = this.reportSettings.lab_height;

      axios
        .get(`/api/me/print/${report}/${format}`, {
          params
        })
        .then(response => {
          const { data } = response;

          if (format === "b64") {
            const size = new PrintSize(
              this.reportSettings.lab_width,
              this.reportSettings.lab_height
            );
            const margins = {
              top: this.reportSettings.lab_margin_top,
              right: this.reportSettings.lab_margin_right,
              bottom: this.reportSettings.lab_margin_bottom,
              left: this.reportSettings.lab_margin_left
            };
            const job = new PrintJob(data.url, size, margins);

            this.printerAddJob(job);
          } else if (!_.isEmpty(data.url)) {
            let win = window.open(data.url);
            if (win) {
              win.addEventListener(
                "load",
                () => {
                  win.print();

                  if (data.next_page && data.next_page !== page) {
                    this.print(report, format, data.next_page);
                  }
                },
                false
              );
            } else {
              this.$toastr.e(
                "Please add a popup exception to print this report.",
                "Failed to display PDF."
              );
            }
          }
        })
        .catch(err => {
          this.$toastr.e(
            "Please confirm that orders exist for the selected date range and disable any popup blocker in our browser.",
            "Failed to print report."
          );
        })
        .finally(() => {
          this.loading = false;
        });
    },
    async exportData(report, format = "pdf", print = false, page = 1) {
      let params = { page };

      let dates = this.delivery_dates[report];
      if (dates.start && dates.end) {
        params.delivery_dates = {
          from: dates.start,
          to: dates.end
        };

        const warning = this.checkDateRange({ ...dates });
        if (warning) {
          try {
            let dialog = await this.$dialog.confirm(
              "You have selected a date range which includes delivery days which haven't passe" +
                "d their cutoff period. This means new orders can still come in for those days. Continue?"
            );
            dialog.close();
          } catch (e) {
            return;
          }
        }
      }

      params.dailySummary = 0;

      axios
        .get(`/api/me/print/${report}/${format}`, {
          params
        })
        .then(response => {
          const { data } = response;
          if (!_.isEmpty(data.url)) {
            let win = window.open(data.url);

            if (win) {
              if (print) {
                win.addEventListener(
                  "load",
                  () => {
                    win.print();
                  },
                  false
                );
              }

              if (data.next_page && data.next_page !== page) {
                this.exportData(report, format, print, data.next_page);
              }
            } else {
              this.$toastr.e(
                "Please add a popup exception to print this report.",
                "Failed to display PDF."
              );
            }
          }
        })
        .catch(err => {})
        .finally(() => {
          this.loading = false;
        });
    },
    clearMealOrders() {
      this.delivery_dates.meal_orders.start = null;
      this.delivery_dates.meal_orders.end = null;
      this.$refs.mealOrdersDates.clearDates();
    },
    clearIngredientQuantities() {
      this.delivery_dates.ingredient_quantities.start = null;
      this.delivery_dates.ingredient_quantities.end = null;
      this.$refs.ingredientQuantitiesDates.clearDates();
    },
    clearOrdersByCustomer() {
      this.delivery_dates.orders_by_customer.start = null;
      this.delivery_dates.orders_by_customer.end = null;
      this.$refs.ordersByCustomerDates.clearDates();
    },
    clearPackingSlips() {
      this.delivery_dates.packing_slips.start = null;
      this.delivery_dates.packing_slips.end = null;
      this.$refs.packingSlipsDates.clearDates();
    },
    clearDeliveryRoutes() {
      this.delivery_dates.delivery_routes.start = null;
      this.delivery_dates.delivery_routes.end = null;
      this.$refs.deliveryRoutesDates.clearDates();
    },
    clearPayments() {
      this.delivery_dates.delivery_routes.start = null;
      this.delivery_dates.delivery_routes.end = null;
      this.$refs.payments.clearDates();
    },
    clearLabels() {
      this.delivery_dates.labels.start = null;
      this.delivery_dates.labels.end = null;
      this.$refs.payments.clearDates();
    },
    showSettings(report) {
      switch (report) {
        case "labels":
          this.showSettingsModal.labels = true;
          break;
      }
    },
    updateReportSettings() {
      let settings = { ...this.reportSettings };
      axios
        .post("/api/me/updateReportSettings", settings)
        .then(response => {
          // this.refreshStoreReportSettings();
          this.$toastr.s("Your settings have been saved.", "Success");
        })
        .catch(response => {
          let error = _.first(Object.values(response.response.data.errors));
          error = error.join(" ");
          this.$toastr.w(error);
        });
    }
  }
};
</script>
